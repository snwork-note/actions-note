name: Note Auto Post

on:
  workflow_dispatch:
    inputs:
      theme:
        description: "投稿テーマ"
        required: true
      target:
        description: "対象ユーザー"
        required: true
      message:
        description: "投稿本文メッセージ"
        required: true
      cta:
        description: "CTA（行動喚起文）"
        required: true
      tags:
        description: "タグ（カンマ区切り）"
        required: false
      is_public:
        description: "公開設定（true = 公開, false = 非公開）"
        required: true
      dry_run:
        description: "ドライランモード（true = 投稿しない）"
        required: true

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: 🧰 Node.js をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 依存パッケージをインストール
        run: npm ci

      - name: 🧭 Playwright ブラウザをインストール
        run: |
          npx playwright install --with-deps
          echo "✅ Playwright browsers installed successfully"

      - name: 🚀 Note に自動投稿
        env:
          NOTE_STORAGE_STATE_JSON: ${{ secrets.NOTE_STORAGE_STATE_JSON }}
          THEME: ${{ github.event.inputs.theme }}
          TARGET: ${{ github.event.inputs.target }}
          MESSAGE: ${{ github.event.inputs.message }}
          CTA: ${{ github.event.inputs.cta }}
          TAGS: ${{ github.event.inputs.tags }}
          IS_PUBLIC: ${{ github.event.inputs.is_public }}
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          echo "Starting Note auto-post workflow..."
          node post.mjs
